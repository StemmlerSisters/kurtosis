openapi: 3.0.0

info:
  title: Enclave API
  description: API to manipulate the enclaves
  version: 0.1.0

paths:

  /enclaves/{enclave_identifier}/starlark:
    get:
      description: Get last Starlark run
      parameters:
        - $ref: '#/components/parameters/enclave_identifier'
      responses:
        "200":
          description: Successful request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StarlarkDescription"

  /enclaves/{enclave_identifier}/starlark/packages:
    post:
      description: Uploads a Starlark package. This step is required before the package can be executed with RunStarlarkPackage
      parameters:
        - $ref: '#/components/parameters/enclave_identifier'
      requestBody:
        $ref: "#/components/requestBodies/fileUploadBody"
      responses:
        "200":
          description: Success

  /enclaves/{enclave_identifier}/starlark/packages/{package_id}:
    post:
      description: Executes a Starlark script on the user's behalf
      parameters:
        - $ref: '#/components/parameters/enclave_identifier'
        - $ref: '#/components/parameters/package_id'
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RunStarlarkPackage"
        required: true
      responses:
        "200":
          description: Successful request
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/StarlarkRunResponseLine"

  /enclaves/{enclave_identifier}/starlark/scripts:
    post:
      description: Executes a Starlark script on the user's behalf
      parameters:
        - $ref: '#/components/parameters/enclave_identifier'
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RunStarlarkScript"
        required: true
      responses:
        "200":
          description: Successful request
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/StarlarkRunResponseLine"

  /enclaves/{enclave_identifier}/services/{service_identifier}:
    get:
      parameters:
        - $ref: '#/components/parameters/enclave_identifier'
        - $ref: '#/components/parameters/service_identifier'
      responses:
        "200":
          description: Successful request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceInfo"

  /enclaves/{enclave_identifier}/services/history:
    get:
      description: Returns information about all existing & historical services
      parameters:
        - $ref: '#/components/parameters/enclave_identifier'
      responses:
        "200":
          description: Successful request
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ServiceIdentifiers"

  /enclaves/{enclave_identifier}/services:
    get:
      parameters:
        - $ref: '#/components/parameters/enclave_identifier'
        - in: query
          name: services
          schema:
            type: array
            items:
              type: string
          description: Select services to get information
      responses:
        "200":
          description: Successful request
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  $ref: "#/components/schemas/ServiceInfo"

  /enclaves/{enclave_identifier}/services/{service_identifier}/command:
    post:
      description: Executes the given command inside a running container
      parameters:
        - $ref: '#/components/parameters/enclave_identifier'
        - $ref: '#/components/parameters/service_identifier'
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExecCommand"
        description: Exec Command
        required: true
      responses:
        "200":
          description: Successful request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExecCommandResult"

  /enclaves/{enclave_identifier}/services/{service_identifier}/endpoints/{port_number}/availability:
    post:
      description: Block until the given HTTP endpoint returns available, calling it through a HTTP Get request
      parameters:
        - $ref: '#/components/parameters/enclave_identifier'
        - $ref: '#/components/parameters/service_identifier'
        - $ref: '#/components/parameters/port_number'
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WaitForEndpointAvailability"
        description: Wait For HTTP Get Endpoint Availability
        required: true
      responses:
        "200":
          description: Success

  /enclaves/{enclave_identifier}/artifacts:
    get:
      description: List all files artifacts
      parameters:
        - $ref: '#/components/parameters/enclave_identifier'
      responses:
        "200":
          description: Successful request
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/FileArtifactReference"

  /enclaves/{enclave_identifier}/artifacts/{artifact_identifier}:
    get:
      parameters:
        - $ref: '#/components/parameters/enclave_identifier'
        - $ref: '#/components/parameters/artifact_identifier'
      description: Inspect the content of a file artifact
      responses:
        "200":
          description: Successful request
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/FileArtifactDescription"

  /enclaves/{enclave_identifier}/artifacts/{artifact_identifier}/download:
    get:
      description: Downloads a files artifact from the Kurtosis File System
      parameters:
        - $ref: '#/components/parameters/enclave_identifier'
        - $ref: '#/components/parameters/artifact_identifier'
      responses:
        "200":
          description: Successful request
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary

  /enclaves/{enclave_identifier}/artifacts/local-file:
    post:
      description: Uploads a files artifact to the Kurtosis File System
      parameters:
        - $ref: '#/components/parameters/enclave_identifier'
      requestBody:
        $ref: "#/components/requestBodies/fileUploadBody"
      responses:
        "200":
          description: Successful request
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  $ref: "#/components/schemas/FileArtifactReference"

  /enclaves/{enclave_identifier}/artifacts/remote-file:
    post:
      description: Tells the API container to download a files artifact from the web to the Kurtosis File System
      parameters:
        - $ref: '#/components/parameters/enclave_identifier'
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StoreWebFilesArtifact"
        description: Store Web Files Artifact
        required: true
      responses:
        "200":
          description: Successful request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FileArtifactReference"

  /enclaves/{enclave_identifier}/artifacts/services/{service_identifier}:
    post:
      description: Tells the API container to copy a files artifact from a service to the Kurtosis File System
      parameters:
        - $ref: '#/components/parameters/enclave_identifier'
        - $ref: '#/components/parameters/service_identifier'
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StoreFilesArtifactFromService"
        required: true
      responses:
        "200":
          description: Successful request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FileArtifactReference"

  /enclaves/{enclave_identifier}/services/connection:
    post:
      description: User services port forwarding
      parameters:
        - $ref: '#/components/parameters/enclave_identifier'
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Connect"
        required: true
      responses:
        "200":
          description: Successful request

# =========================================================================================================================
# =========================================================================================================================
# > > > > > > > > > > > > > > > > > > > > > > > > Data Models < < < < < < < < < < < < < < < < < < < < < < < < < < < < < < < 
# =========================================================================================================================
# =========================================================================================================================

components:

  parameters:

    enclave_identifier:
      in: path
      name: enclave_identifier
      schema:
        type: string
        description: The package identifier that will be executed
      required: true

    service_identifier:
      in: path
      name: service_identifier
      schema:
        type: string
      description: The service identifier of the container that the command should be executed in
      required: true
        
    port_number:
      in: path
      name: port_number
      schema:
        type: integer
        format: int32
      description: The port number to check availability
      required: true
  
    artifact_identifier:
      in: path
      name: artifact_identifier
      schema:
        type: string
      description: The artifact name or uuid
      required: true
        
    package_id:
      in: path
      name: package_id
      schema:
        type: string
      description: The package identifier that will be executed
      required: true

  requestBodies:

    fileUploadBody:
      content:
        multipart/form-data:
          schema:
            type: string
            format: binary

  schemas:

    Port:
      type: object
      properties:
        number:
          type: integer
          format: int32
        transport_protocol:
          $ref: "#/components/schemas/TransportProtocol"
        application_protocol:
          type: string
        wait_timeout:
          type: string
          description: The wait timeout duration in string
      required:
        - number
        - transport_protocol
      description: Shared Objects (Used By Multiple Endpoints)

    Container:
      type: object
      properties:
        status:
          $ref: "#/components/schemas/ContainerStatus"
        image_name:
          type: string
        entrypoint_args:
          type: array
          items:
            type: string
        cmd_args:
          type: array
          items:
            type: string
        env_vars:
          type: object
          additionalProperties:
            type: string
      required:
        - status
        - image_name
        - entrypoint_args
        - cmd_args
        - env_vars

    ServiceStatus:
      type: string
      enum:
        - STOPPED
        - RUNNING
        - UNKNOWN
      description: |-
        0 - STOPPED 
        1 - RUNNING 
        2 - UNKNOWN

    ImageDownloadMode:
      type: string
      enum:
        - ALWAYS
        - MISSING
      description: |-
        0 - ALWAYS 
        1 - MISSING

    ServiceInfo:
      type: object
      properties:
        service_uuid:
          type: string
          description: UUID of the service
        private_ip_addr:
          type: string
          description: The IP address of the service inside the enclave
        private_ports:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/Port"
        public_ip_addr:
          type: string
          description: |-
            Public IP address *outside* the enclave where the service is reachable
            NOTE: Will be empty if the service isn't running, the service didn't define any ports, or the backend doesn't support reporting public service info
        public_ports:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/Port"
        name:
          type: string
          description: Name of the service
        shortened_uuid:
          type: string
          description: Shortened uuid of the service
        service_status:
          $ref: "#/components/schemas/ServiceStatus"
        container:
          $ref: "#/components/schemas/Container"
      required:
        - service_uuid
        - private_ip_addr
        - private_ports
        - name
        - shortened_uuid
        - service_status
        - container

    Connect:
      type: string
      enum:
        - CONNECT
        - NO_CONNECT
      description: |-
        0 - CONNECT // Best effort port forwarding
        1 - NO_CONNECT // Port forwarding disabled

    RunStarlarkScript:
      type: object
      properties:
        serialized_script:
          type: string
        params:
          type: object
          additionalProperties: true
          description: |-
            Parameters data for the Starlark package main function
        dry_run:
          type: boolean
          description: Defaults to false
        parallelism:
          type: integer
          format: int32
          description: Defaults to 4
        main_function_name:
          type: string
          description: The name of the main function, the default value is "run"
        experimental_features:
          type: array
          items:
            $ref: "#/components/schemas/KurtosisFeatureFlag"
        cloud_instance_id:
          type: string
          description: Defaults to empty
        cloud_user_id:
          type: string
          description: Defaults to empty
        image_download_mode:
          $ref: "#/components/schemas/ImageDownloadMode"
      required:
        - serialized_script

    RunStarlarkPackage:
      type: object
      properties:
        local:
          type: string
          format: byte
          description: the payload of the local module
        remote:
          type: boolean
          description: just a flag to indicate the module must be cloned inside the API
        params:
          type: object
          additionalProperties: true
          description: |-
            Parameters data for the Starlark package main function
        dry_run:
          type: boolean
          description: Defaults to false
        parallelism:
          type: integer
          format: int32
          description: Defaults to 4
        clone_package:
          type: boolean
          description: |-
            Whether the package should be cloned or not.
            If false, then the package will be pulled from the APIC local package store. If it's a local package then is must
            have been uploaded using UploadStarlarkPackage prior to calling RunStarlarkPackage.
            If true, then the package will be cloned from GitHub before execution starts
        relative_path_to_main_file:
          type: string
          description: The relative main file filepath, the default value is the "main.star" file in the root of a package
        main_function_name:
          type: string
          description: The name of the main function, the default value is "run"
        experimental_features:
          type: array
          items:
            $ref: "#/components/schemas/KurtosisFeatureFlag"
        cloud_instance_id:
          type: string
          description: Defaults to empty
        cloud_user_id:
          type: string
          description: Defaults to empty
        image_download_mode:
          $ref: "#/components/schemas/ImageDownloadMode"

    KurtosisFeatureFlag:
      type: string
      enum:
        - NO_INSTRUCTIONS_CACHING
      description: |-
        0 - NO_INSTRUCTIONS_CACHING

    StarlarkRunResponseLine:
      oneOf: 
        - $ref: "#/components/schemas/StarlarkInstruction"
        - $ref: "#/components/schemas/StarlarkError"
        - $ref: "#/components/schemas/StarlarkRunProgress"
        - $ref: "#/components/schemas/StarlarkInstructionResult"
        - $ref: "#/components/schemas/StarlarkRunFinishedEvent"
        - $ref: "#/components/schemas/StarlarkWarning"
        - $ref: "#/components/schemas/StarlarkInfo"
      description: |-
        Starlark Execution Response

    StarlarkInfo:
      type: object
      properties:
        info:
          type: object
          properties:
            instruction:
              type: object
              properties:
                info_message:
                  type: string
              required:
                - info_message
          required:
            - instruction
      required:
        - info

    StarlarkWarning:
      type: object
      properties:
        warning:
          type: object
          properties:
            warning_message:
              type: string
          required:
            - warning_message
      required:
        - warning

    StarlarkInstruction:
      type: object
      properties:
        position:
          $ref: "#/components/schemas/StarlarkInstructionPosition"
        instruction_name:
          type: string
        arguments:
          type: array
          items:
            $ref: "#/components/schemas/StarlarkInstructionArgument"
        executable_instruction:
          type: string
        is_skipped:
          type: boolean
      required:
        - position
        - instruction_name
        - arguments
        - executable_instruction
        - is_skipped

    StarlarkInstructionResult:
      type: object
      properties:
        instruction_result:
          type: object
          properties:
            serialized_instruction_result:
              type: string
          required:
            - serialized_instruction_result
      required:
        - instruction_result

    StarlarkInstructionArgument:
      type: object
      properties:
        serialized_arg_value:
          type: string
        arg_name:
          type: string
        is_representative:
          type: boolean
      required:
        - serialized_arg_value
        - is_representative

    StarlarkInstructionPosition:
      type: object
      properties:
        filename:
          type: string
        line:
          type: integer
          format: int32
        column:
          type: integer
          format: int32
      required:
        - filename
        - line
        - column

    StarlarkError:
      type: object
      properties:
        error:
          oneOf:
              - $ref: "#/components/schemas/StarlarkInterpretationError"
              - $ref: "#/components/schemas/StarlarkValidationError"
              - $ref: "#/components/schemas/StarlarkExecutionError"
      required:
        - error

    StarlarkInterpretationError:
      type: object
      properties:
        interpretation_error:
          type: object
          properties:
            error_message:
              type: string
          required:
            - error_message
      required:
        - interpretation_error

    StarlarkValidationError:
      type: object
      properties:
        validation_error:
          type: object
          properties:
            error_message:
              type: string
          required:
            - error_message
      required:
        - validation_error

    StarlarkExecutionError:
      type: object
      properties:
        execution_error:
          type: object
          properties:
            error_message:
              type: string
          required:
            - error_message
      required:
        - execution_error

    StarlarkRunProgress:
      type: object
      properties:
        progress_info:
          type: object
          properties:
            current_step_info:
              type: array
              items:
                type: string
            total_steps:
              type: integer
              format: int32
            current_step_number:
              type: integer
              format: int32
          required:
            - current_step_info
            - total_steps
            - current_step_number
      required:
        - progress_info

    StarlarkRunFinishedEvent:
      type: object
      properties:
        run_finished_event:
          type: object
          properties:
            is_run_successful:
              type: boolean
            serialized_output:
              type: string
          required:
            - is_run_successful
            - serialized_output
      required:
        - run_finished_event

    ServiceIdentifiers:
      type: object
      properties:
        service_uuid:
          type: string
          description: UUID of the service
        name:
          type: string
          description: Name of the service
        shortened_uuid:
          type: string
          description: The shortened uuid of the service
      description: An service identifier is a collection of uuid, name and shortened uuid
      required:
        - service_uuid
        - name
        - shortened_uuid

    ExecCommand:
      type: object
      properties:
        command_args:
          type: array
          items:
            type: string
      description: Exec Command
      required:
        - command_args

    ExecCommandResult:
      type: object
      properties:
        exit_code:
          type: integer
          format: int32
        log_output:
          type: string
          description: Assumes UTF-8 encoding
      required:
        - exit_code
        - log_output

    WaitForEndpointAvailability:
      type: object
      properties:
        http_method:
          type: string
          enum: [GET, POST]
        path:
          type: string
          description: The path of the service to check. It mustn't start with the first slash. For instance `service/health`
        initial_delay_milliseconds:
          type: integer
          format: int32
          description: The number of milliseconds to wait until executing the first HTTP call
        retries:
          type: integer
          format: int32
          description: Max number of HTTP call attempts that this will execute until giving up and returning an error
        retries_delay_milliseconds:
          type: integer
          format: int32
          description: Number of milliseconds to wait between retries
        body_text:
          type: string
          description: If the endpoint returns this value, the service will be marked as available (e.g. Hello World).
      description: Wait For HTTP Endpoint Availability
      required:
        - http_method

    FileArtifactReference:
      type: object
      properties:
        uuid:
          type: string
          description: UUID of the files artifact, for use when referencing it in the future
        name:
          type: string
          description: UUID of the files artifact, for use when referencing it in the future
      description: |-
        Files Artifact identifier
      required:
        - uuid
        - name

    StoreWebFilesArtifact:
      type: object
      properties:
        url:
          type: string
          description: URL to download the artifact from
        name:
          type: string
          description: The name of the files artifact
      required:
        - url
        - name
      description: |-
        Store Web Files Artifact

    StoreFilesArtifactFromService:
      type: object
      properties:
        source_path:
          type: string
          description: The absolute source path where the source files will be copied from
        name:
          type: string
          description: The name of the files artifact
      required:
        - source_path
        - name

    FileArtifactDescription:
      type: object
      properties:
        path:
          type: string
          description: Path relative to the file artifact
        size:
          type: integer
          format: int64
          description: Size of the file, in bytes
        text_preview:
          type: string
          description: A bit of text content, if the file allows (similar to UNIX's 'head')
      required:
        - path
        - size

    RestartPolicy:
      type: string
      enum:
        - NEVER
        - ALWAYS
      description: |-
        0 - NEVER 
        1 - ALWAYS

    StarlarkDescription:
      type: object
      properties:
        package_id:
          type: string
        serialized_script:
          type: string
        serialized_params:
          type: string
        parallelism:
          type: integer
          format: int32
        relative_path_to_main_file:
          type: string
        main_function_name:
          type: string
        experimental_features:
          type: array
          items:
            $ref: "#/components/schemas/KurtosisFeatureFlag"
        restart_policy:
          $ref: "#/components/schemas/RestartPolicy"
      required:
        - package_id
        - serialized_script
        - serialized_params
        - parallelism
        - relative_path_to_main_file
        - main_function_name
        - experimental_features
        - restart_policy

    TransportProtocol:
      type: string
      enum:
        - TCP
        - SCTP
        - UDP
      description: |-
        0 - TCP 
        1 - SCTP 
        2 - UDP

    ContainerStatus:
      type: string
      enum:
        - STOPPED
        - RUNNING
        - UNKNOWN
      description: |-
        0 - STOPPED 
        1 - RUNNING 
        2 - UNKNOWN
