package exec

import (
	"github.com/stretchr/testify/require"
	"strings"
	"testing"
)

func TestGetAutoGeneratedEnclaveIdString_simple(t *testing.T) {
	result := getAutoGeneratedEnclaveIdStr("./path/to/script.stsis")
	expectedEnclaveIdPrefix := "script.stsis--"

	require.True(t, strings.HasPrefix(result, expectedEnclaveIdPrefix),
		"Enclave ID '%s' was expected to start with '%s'", result, expectedEnclaveIdPrefix)
}

func TestGetAutoGeneratedEnclaveIdString_withSymbols(t *testing.T) {
	result := getAutoGeneratedEnclaveIdStr("./path/to/script@^%#1234$v3.stsis")
	expectedEnclaveIdPrefix := "script-1234-v3.stsis--"
	require.True(t, strings.HasPrefix(result, expectedEnclaveIdPrefix),
		"Enclave ID '%s' was expected to start with '%s'", result, expectedEnclaveIdPrefix)
}

func TestGetAutoGeneratedEnclaveIdString_tooLong(t *testing.T) {
	result := getAutoGeneratedEnclaveIdStr("./path/to/script@^%#1234$VeryLongPrefixLongerThan64CharactersAndThatIsNotAllowedForAnEnclaveId.stsis")
	expectedEnclaveIdPrefix := "script-1234-VeryLongPrefixLongerThan64CharactersAnd--"
	require.True(t, strings.HasPrefix(result, expectedEnclaveIdPrefix),
		"Enclave ID '%s' was expected to start with '%s'", result, expectedEnclaveIdPrefix)
}

func TestValidateArgs_valid(t *testing.T) {
	input := `{"hello": "world!"}`
	err := validateModuleArgs(input)
	require.Nil(t, err)
}

func TestValidateArgs_invalid(t *testing.T) {
	input := `"hello": "world!"` // missing { }
	err := validateModuleArgs(input)
	require.NotNil(t, err)
}
